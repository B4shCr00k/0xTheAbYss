<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Hello From Kernel In this guide i will help you write your first windows kernel driver using kmdf\nThis Guide Will Cover What are drivers\nPrerequisite\nUser Mode VS Kernel Mode\nCode WalkThrough\nCompiling and loading the driver\nWhat Are Drivers A driver is a piece of software that allows the operating system to communicate with hardware devices. In our case, we are developing what&rsquo;s known as a software driver, a type of driver that facilitates communication between user mode and kernel mode, without necessarily interacting with physical hardware. These drivers are essential for tasks that require privileged access to system resources, such as monitoring, hooking, or custom control mechanisms.\n">
<title>Introduction Into Windows Kernel Drivers</title>

<link rel='canonical' href='https://B4shCr00k.github.io/0xTheAbYss/posts/introduction-into-windows-kernel-drivers/'>

<link rel="stylesheet" href="/0xTheAbYss/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css"><meta property='og:title' content="Introduction Into Windows Kernel Drivers">
<meta property='og:description' content="Hello From Kernel In this guide i will help you write your first windows kernel driver using kmdf\nThis Guide Will Cover What are drivers\nPrerequisite\nUser Mode VS Kernel Mode\nCode WalkThrough\nCompiling and loading the driver\nWhat Are Drivers A driver is a piece of software that allows the operating system to communicate with hardware devices. In our case, we are developing what&rsquo;s known as a software driver, a type of driver that facilitates communication between user mode and kernel mode, without necessarily interacting with physical hardware. These drivers are essential for tasks that require privileged access to system resources, such as monitoring, hooking, or custom control mechanisms.\n">
<meta property='og:url' content='https://B4shCr00k.github.io/0xTheAbYss/posts/introduction-into-windows-kernel-drivers/'>
<meta property='og:site_name' content='B4shCr00k'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Drivers' /><meta property='article:tag' content='Windows' /><meta property='article:tag' content='Kernel' /><meta property='article:published_time' content='2025-07-26T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-07-26T00:00:00&#43;00:00'/><meta property='og:image' content='https://B4shCr00k.github.io/0xTheAbYss/posts/introduction-into-windows-kernel-drivers/raven.jpg' />
<meta name="twitter:title" content="Introduction Into Windows Kernel Drivers">
<meta name="twitter:description" content="Hello From Kernel In this guide i will help you write your first windows kernel driver using kmdf\nThis Guide Will Cover What are drivers\nPrerequisite\nUser Mode VS Kernel Mode\nCode WalkThrough\nCompiling and loading the driver\nWhat Are Drivers A driver is a piece of software that allows the operating system to communicate with hardware devices. In our case, we are developing what&rsquo;s known as a software driver, a type of driver that facilitates communication between user mode and kernel mode, without necessarily interacting with physical hardware. These drivers are essential for tasks that require privileged access to system resources, such as monitoring, hooking, or custom control mechanisms.\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://B4shCr00k.github.io/0xTheAbYss/posts/introduction-into-windows-kernel-drivers/raven.jpg' />
    <link rel="shortcut icon" href="/favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/0xTheAbYss/">
                
                    
                    
                    
                        
                        <img src="/0xTheAbYss/img/nice_hu_986d5127a08a7487.jpg" width="300"
                            height="289" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üê¶‚Äç‚¨õ</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/0xTheAbYss">B4shCr00k</a></h1>
            <h2 class="site-description">so high all the time</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/B4shCr00k'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://x.com/B4shCr00k'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/0xTheAbYss/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/0xTheAbYss/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/0xTheAbYss/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/0xTheAbYss/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#what-are-drivers">What Are Drivers</a></li>
    <li><a href="#prerequisite">Prerequisite</a></li>
    <li><a href="#user-mode-vs-kernel-mode">User Mode VS Kernel Mode</a></li>
    <li><a href="#code-walkthrough">Code WalkThrough</a></li>
    <li><a href="#compiling-and-loading-the-driver">Compiling and loading the driver</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/0xTheAbYss/posts/introduction-into-windows-kernel-drivers/">
                <img src="/0xTheAbYss/posts/introduction-into-windows-kernel-drivers/raven_hu_f27c086a70554871.jpg"
                        srcset="/0xTheAbYss/posts/introduction-into-windows-kernel-drivers/raven_hu_f27c086a70554871.jpg 800w, /0xTheAbYss/posts/introduction-into-windows-kernel-drivers/raven_hu_53bd688b38d76065.jpg 1600w"
                        width="800" 
                        height="339" 
                        loading="lazy"
                        alt="Featured image of post Introduction Into Windows Kernel Drivers" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/0xTheAbYss/categories/docs/" style="background-color: #03030328; color: #fff;">
                docs
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/0xTheAbYss/posts/introduction-into-windows-kernel-drivers/">Introduction Into Windows Kernel Drivers</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jul 26, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    8 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="hello-from-kernel">Hello From Kernel
</h1><p>In this guide i will help you write your first windows kernel driver using kmdf</p>
<h1 id="this-guide-will-cover">This Guide Will Cover
</h1><ul>
<li>
<p>What are drivers</p>
</li>
<li>
<p>Prerequisite</p>
</li>
<li>
<p>User Mode VS Kernel Mode</p>
</li>
<li>
<p>Code WalkThrough</p>
</li>
<li>
<p>Compiling and loading the driver</p>
</li>
</ul>
<h2 id="what-are-drivers">What Are Drivers
</h2><p>A driver is a piece of software that allows the operating system to communicate with hardware devices. In our case, we are developing what&rsquo;s known as a software driver, a type of driver that facilitates communication between user mode and kernel mode, without necessarily interacting with physical hardware. These drivers are essential for tasks that require privileged access to system resources, such as monitoring, hooking, or custom control mechanisms.</p>
<p>When it comes to malware and rootkits, drivers take on a more malicious role. In this context, a driver can be used to gain low-level access to the operating system, often bypassing security mechanisms like User Account Control (UAC) or antivirus protections. Kernel-mode drivers used by rootkits can hide files, processes, or registry keys, intercept system calls, and exert stealthy control over the system‚Äîmaking them one of the most powerful tools in advanced malware development.</p>
<h2 id="prerequisite">Prerequisite
</h2><ul>
<li>
<p>First of all you really don&rsquo;t want to test drivers on your main (host) machine since any fatal mistake will make your system crash therefore having a testing environnement is so important i advice using a virtual machine you can use vmware (free version) or virtual box which is free as well</p>
</li>
<li>
<p>once you have the testing machine ready disable memory integrity options from the windows security settings then we need to enable test signing to do so run the following commands on an elevated cmd (run as administrator)</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">bcdedit</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">set</span> <span class="n">loadoptions</span> <span class="n">DISABLE_INTEGRITY_CHECKS</span>
</span></span><span class="line"><span class="cl"><span class="n">bcdedit</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">set</span> <span class="n">TESTSIGNING</span> <span class="n">ON</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>you might get something like &ldquo;The value is protected by Secure Boot policy and cannot be modified or deleted&rdquo; in this case you have secure boot on you should go google how to disable secure boot for your machine usually from the bios</p>
<ul>
<li>
<p>now we are done from setting up the testing machine lets set up the machine where we will be coding our diver, first you will need to install visual studio, sdk and wdk <a class="link" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/download-the-wdk"  target="_blank" rel="noopener"
    >here</a> is a guide by microsoft</p>
</li>
<li>
<p>next we can set up kernel debugging using windbg but its pretty complicated and unnecessary for now so we you can just download DebugView on the testing machine</p>
</li>
<li>
<p>finally we create a kmdf empty project using visual studio add a main.c under your source folder and delete the driver you will find under driver files since we dont need it</p>
</li>
</ul>
<h2 id="user-mode-vs-kernel-mode">User Mode VS Kernel Mode
</h2><p>for security, stability, and control reasons execution is split into two modes :</p>
<p>&mdash; user mode where normal programs like browsers games text editors run it cannot access memory used by the os and needs to call the os using high level api windows functions in order to do such things, programs in user mode has a private virtual memory meaning when a process runs it thinks it owns the entire memory to it self this is implemented for security reasons as well as other reasons read <a class="link" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/virtual-address-spaces"  target="_blank" rel="noopener"
    >this</a> for more infos on virtual memory</p>
<p>&mdash; kernel mode where the kernel itself, drivers and os programs run it can literally do anything in this system in kernel mode you have full access to hardware, memory and system resources all programs that run in kernel mode share the same virtual space meaning if something happens to one program it will crash the entire system leading to a BSOD or other fatal errors</p>
<p>drivers are like a bridge that allow us to run code in kernel space</p>
<h2 id="code-walkthrough">Code WalkThrough
</h2><p>Now We will code a simple hello world from the kernel poc</p>
<p>we need to be very careful when coding drivers and we need to follow a spesific structure open main.c and lets start coding</p>
<ul>
<li>
<p>first we include  <code>#include &lt;ntddk.h&gt;</code> which has everything we need to code our driver</p>
</li>
<li>
<p>next we define something called a tag which is used to track down memory allocations made by the driver we use this for debugging so we can easily know what driver allocated this memory space <code>#define DRIVER_TAG 'gaT'</code> first we write the name in reverse due to the little endian and use single quotes we also need to define a  <code>UNICODE_STRING</code> which is a structure for unicode strings which a lot of low level functions need it has 3 fields <code>length</code> which is the size of the buffer in bytes and not null terminated <code>MaximumLength</code> which is the max size the buffer can hold <code>buffer</code> the actual unicode string so <code>UNICODE_STRING g_RegPath;</code></p>
</li>
<li>
<p>next we define our entrypoint which is <code>NTSTATUS DriverEntry(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</code> the driverobject is a struct that holds all the important infos about our drivers it has things like <code>DriverObject-&gt;DriverUnload</code> which is the code that will get executed once the driver is unloaded this struct is very important and is like a handle to control the driver, the registery path is a unicode string that has something like &ldquo;\Registry\Machine\System\CurrentControlSet\Services\MyDriver&rdquo; we will print it later</p>
</li>
<li>
<p>inside our function we will be using something called<code>DbgPrint();</code> which is just like <code>printf()</code> in user mode this function will allow us to debug the driver using print statements we can later read using debugging tools, next we print the driverobject and the registerypath like this</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">	DbgPrint(&#34;[+] Driver Object: %p\n&#34;, DriverObject);
</span></span><span class="line"><span class="cl">   DbgPrint(&#34;[+] Registry Path: %p\n&#34;, RegistryPath);
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>next we will allocate space for our buffer to populate our <code>g_RegPath</code> unicode string struct we do this so can save the reg path for later use since its only save to access it i the DriverEntry only to do this we will get into memory allocation in kernel mode, there are more than one function to allocate space in kernel mode unlike use mode where we can use malloc we can use <code>ExAllocatePool2()</code> which is a new function used to allocate space in memory safely so <code>g_RegPath.Buffer = (PWSTR)ExAllocatePool2(POOL_FLAG_PAGED, RegistryPath-&gt;Length, DRIVER_TAG)</code> we are allocating space for our buffer and we store the pointer inside <code>g_RegPath.Buffer</code> the first argument is <code>POOL_FLAG_PAGED</code> read more about memory pools <a class="link" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/virtual-addres"  target="_blank" rel="noopener"
    >here</a> next we can how many bytes we will allocate <code>RegistryPath-&gt;Length</code>  which is the length of the regpath buffer, finally we have the tag we will use for this memory space <code>DRIVER_TAG</code> which is Test in our case next we run a test to see if it the buffer is still null just like with malloc</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">	if (g_RegPath.Buffer == NULL)
</span></span><span class="line"><span class="cl">   {
</span></span><span class="line"><span class="cl">   	DbgPrint(&#34;[-] Failed To Allocate Space For The Reg&#34;);
</span></span><span class="line"><span class="cl">   	return STATUS_NO_MEMORY;
</span></span><span class="line"><span class="cl">   }
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>then we copy the registerypath from the param into our buffer using memcpy <code>memcpy(g_RegPath.Buffer, RegistryPath-&gt;Buffer, RegistryPath-&gt;Length);</code> also we set the length to same length <code>	g_RegPath.Length = g_RegPath.MaximumLength = RegistryPath-&gt;Length;</code> and finally we dbgprint a message <code>	DbgPrint(&quot;Param Key Copy %wZ\n&quot;,g_RegPath)</code></p>
</li>
<li>
<p>now we need to set <code>DriverObject-&gt;DriverUnload</code> into our unload function which will run when the driver unload <code>DriverObject-&gt;DriverUnload = UnloadMe</code> so make sure you defined this function before the DriverEntry Function so the compiler can recognize it</p>
</li>
<li>
<p>now we code the actual UnloadMe function it takes one param which is the driverobject struct for now we will just free the allocated space which is something you should always do in kernel mode</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">void</span> <span class="n">UnloadMe</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">DriverObject</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">UNREFERENCED_PARAMETER</span><span class="p">(</span><span class="n">DriverObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">DbgPrint</span><span class="p">(</span><span class="s2">&#34;[+] Driver unloaded successfully.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">DbgPrint</span><span class="p">(</span><span class="s2">&#34;[+] Driver Object: %p</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">DriverObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="n">g_RegPath</span><span class="o">.</span><span class="n">Buffer</span> <span class="o">!=</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   	<span class="n">ExFreePool</span><span class="p">(</span><span class="n">g_RegPath</span><span class="o">.</span><span class="n">Buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   	<span class="n">g_RegPath</span><span class="o">.</span><span class="n">Buffer</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="n">DbgPrint</span><span class="p">(</span><span class="s2">&#34;[+] Driver Unloaded</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>we used <code>ExFreePool(g_RegPath.Buffer);</code> which is just like <code>free()</code> in um</p>
<h2 id="compiling-and-loading-the-driver">Compiling and loading the driver
</h2><p>to build the project just build in visual studio and make sure you do so in debug mode or all the debug messages wont appear</p>
<ul>
<li>
<p>to install the driver we will use <code>Service Controller</code> (sc.exe) to do so we run this command
<code>sc create HelloWorldDriver type= kernel binPath= C:\MyDrivers\HelloWorldDriver.sys</code> change the path into ur dirver&rsquo;s path you can also change HelloWorldDriver into whatever name u want now open DebugView and enable all the kernel capture options under capture</p>
</li>
<li>
<p>finally we load the driver with <code>sc start HelloWorldDriver</code> or whatever name u chose you should see the messages appear in your DebugView interface if u dont its because you didnt enable the correct options under the capture tab to unload the driver we use <code>sc stop HelloWorldDriver</code></p>
</li>
</ul>
<p>FULL CODE :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="c1">#include &lt;ntddk.h&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define DRIVER_TAG &#39;bdwh&#39; </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">UNICODE_STRING</span> <span class="n">g_RegPath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">UnloadMe</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="n">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">DriverObject</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">RegistryPath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">DbgPrint</span><span class="p">(</span><span class="s2">&#34;[+] Driver loaded successfully.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DbgPrint</span><span class="p">(</span><span class="s2">&#34;[+] Driver Object: %p</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">DriverObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DbgPrint</span><span class="p">(</span><span class="s2">&#34;[+] Registry Path: %p</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">RegistryPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">g_RegPath</span><span class="o">.</span><span class="n">Buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWSTR</span><span class="p">)</span><span class="n">ExAllocatePool2</span><span class="p">(</span><span class="n">POOL_FLAG_PAGED</span><span class="p">,</span> <span class="n">RegistryPath</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">,</span> <span class="n">DRIVER_TAG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">g_RegPath</span><span class="o">.</span><span class="n">Buffer</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DbgPrint</span><span class="p">(</span><span class="s2">&#34;[-] Failed To Allocate Space For The Reg&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">STATUS_NO_MEMORY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">(</span><span class="n">g_RegPath</span><span class="o">.</span><span class="n">Buffer</span><span class="p">,</span> <span class="n">RegistryPath</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">,</span> <span class="n">RegistryPath</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">g_RegPath</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">g_RegPath</span><span class="o">.</span><span class="n">MaximumLength</span> <span class="o">=</span> <span class="n">RegistryPath</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DbgPrint</span><span class="p">(</span><span class="s2">&#34;Param Key Copy %wZ</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="n">g_RegPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">UnloadMe</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">UnloadMe</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">DriverObject</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">UNREFERENCED_PARAMETER</span><span class="p">(</span><span class="n">DriverObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DbgPrint</span><span class="p">(</span><span class="s2">&#34;[+] Driver unloaded successfully.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DbgPrint</span><span class="p">(</span><span class="s2">&#34;[+] Driver Object: %p</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">DriverObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">g_RegPath</span><span class="o">.</span><span class="n">Buffer</span> <span class="o">!=</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ExFreePool</span><span class="p">(</span><span class="n">g_RegPath</span><span class="o">.</span><span class="n">Buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">g_RegPath</span><span class="o">.</span><span class="n">Buffer</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">DbgPrint</span><span class="p">(</span><span class="s2">&#34;[+] Driver Unloaded</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/0xTheAbYss/tags/drivers/">Drivers</a>
        
            <a href="/0xTheAbYss/tags/windows/">Windows</a>
        
            <a href="/0xTheAbYss/tags/kernel/">Kernel</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed by B4shCr00k</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/0xTheAbYss/posts/resolving-imports-remotely/">
        
        
            <div class="article-image">
                <img src="/0xTheAbYss/posts/resolving-imports-remotely/nice.d1b175fe8ece56eeda75e984a90eeb24_hu_cbb4fe977a1ff51e.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Resolving Imports Remotely"
                        
                        data-hash="md5-0bF1/o7OVu7ademEqQ7rJA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Resolving Imports Remotely</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "0xtheabyss" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 B4shCr00k
    </section>
    
    <section class="powerby">
        
            abandon hope all ye who enter here <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/0xTheAbYss/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
